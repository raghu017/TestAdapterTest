trigger:
- main

parameters:
- name: vmImage
  type: string
  default: windows-latest
  values:
  - windows-latest
  - ubuntu-latest
  - macOS-latest
- name: 'buildConfiguration'
  type: string
  default: 'Debug'
  values:
  - 'Debug'
  - 'Release'
- name: 'SPXBuild_id'
  type: number
  default: 26702669
  values:
  - 0
  - 26702669
  
variables:
- name: unzipPattern
  ${{ if eq(parameters.vmImage, 'windows-latest') }}:
    value: '**/spx-netcore31-win-x64.zip'
  ${{ else }}:
    value: '**/spx-netcore31-linux-x64.zip'

jobs:
- job: SPX_Yaml_Test_Pipeline
  pool:
    vmImage: ${{ parameters.vmImage }}

  steps:

    # -----------------------------------------------------------------------------
    # Download the SPX artifact and .net executables
    # -----------------------------------------------------------------------------
    - task: DownloadBuildArtifacts@0
      displayName: Download SPX build artifact (executable)
      inputs:
        buildType: specific
        project: 'e71f1362-9c7d-488b-99c7-3376db8d3302' # Skyman
        pipeline: 13649 # Azure-Samples.cognitive-services-speech-tools
        buildVersionToDownload: specific
        specificBuildWithTriggering: true
        buildId: ${{ parameters.SPXBuild_id }}
        downloadType: specific
        downloadPath: spxBuild
      condition: gt( ${{ parameters.SPXBuild_id }} , 0) # only if we have a build_id

    - task: ExtractFiles@1
      displayName: Extract SPX .netcore 3.1 executable
      inputs:
        archiveFilePatterns: $(parameters.unzipPattern)
        destinationFolder: $(System.DefaultWorkingDirectory)
        cleanDestinationFolder: false
      condition: gt( ${{ parameters.SPXBuild_id }} , 0) # only if we have a build_id

    - task: Bash@3
      displayName: Update path and locationg CLI
      inputs:
        script: |
          echo '##vso[task.setvariable variable=path]$(PATH):~/.dotnet/tools'
          find
          find spx
          find ~/.dotnet/tools/spx
      condition: not(eq('${{ parameters.vmImage }}', 'windows-latest'))


    # -----------------------------------------------------------------------------
    # OR ... install it as a global .net tool
    # -----------------------------------------------------------------------------
    - task: DotNetCoreCLI@2
      inputs:
        command: 'custom'
        custom: 'tool'
        arguments: 'install --global Microsoft.CognitiveServices.Speech.CLI'
      condition: eq( ${{ parameters.SPXBuild_id }} , 0) # only if we have NO build_id

    # -----------------------------------------------------------------------------
    # Run the tests (this will also publish the results)
    # -----------------------------------------------------------------------------
    - task: DotNetCoreCLI@2
      inputs:
        command: 'test'
        arguments: '--configuration ${{ parameters.buildConfiguration }}'
        workingDirectory: $(System.DefaultWorkingDirectory)
